<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-WiSE Architecture Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { opacity: 0; }
        }
        @keyframes flow-line {
            to { stroke-dashoffset: -20; }
        }
        .flow-active {
            stroke-dasharray: 5, 5;
            animation: flow-line 1s linear infinite;
        }
        .node-box {
            transition: all 0.2s ease;
        }
        /* Fixed: Removed translateY to prevent "shaking" on hover */
        .node-box:hover {
            filter: brightness(1.2);
        }
        .data-particle {
            fill: #3b82f6;
            filter: blur(1px);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans min-h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900 z-10">
        <div>
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                Q-WiSE System Architecture
            </h1>
            <p class="text-slate-400 text-sm">Quantized AI-Powered Multi-Channel Wiener Filter (< 50mW)</p>
        </div>
        <div class="flex gap-4">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-mono">CORE: RUST</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-mono">MODEL: ONNX (INT8)</span>
            </div>
        </div>
    </header>

    <!-- Main Canvas Area -->
    <main class="flex-grow relative p-4 flex items-center justify-center">
        <svg id="architecture-svg" viewBox="0 0 1000 600" class="w-full h-full max-w-5xl drop-shadow-2xl">
            <!-- Connection Lines (Back) -->
            <g id="connections" stroke="#334155" stroke-width="2" fill="none">
                <!-- Mic to STFT -->
                <path d="M150 300 L230 300" class="flow-active" stroke="#3b82f6" />
                <!-- STFT to Dual Paths -->
                <path d="M330 300 L380 300" />
                <path d="M380 300 L380 180 L430 180" /> <!-- To AI -->
                <path d="M380 300 L380 420 L430 420" /> <!-- To DSP -->
                <!-- AI Outputs -->
                <path d="M570 180 L650 180 L650 380 L570 420" class="flow-active" stroke="#10b981" /> <!-- Gain Map to Wiener -->
                <path d="M570 180 L800 180 L850 180" class="flow-active" stroke="#f59e0b" /> <!-- Metadata to Output -->
                <!-- Wiener to ISTFT -->
                <path d="M570 420 L650 420 L730 420" />
                <!-- ISTFT to Output -->
                <path d="M830 420 L900 420 L900 300 L850 250" />
            </g>

            <!-- Stages -->
            
            <!-- 1. Capture -->
            <g transform="translate(50, 250)" class="node-box">
                <rect width="100" height="100" rx="12" fill="#1e293b" stroke="#3b82f6" stroke-width="2" />
                <text x="50" y="45" text-anchor="middle" fill="#94a3b8" font-size="10" font-weight="bold">STAGE 1</text>
                <text x="50" y="65" text-anchor="middle" fill="white" font-size="12" font-weight="bold">I2S Capture</text>
                <text x="50" y="80" text-anchor="middle" fill="#3b82f6" font-size="9">DMA Ping-Pong</text>
            </g>

            <!-- 2. Pre-Processing -->
            <g transform="translate(230, 250)" class="node-box">
                <rect width="100" height="100" rx="12" fill="#1e293b" stroke="#3b82f6" stroke-width="2" />
                <text x="50" y="45" text-anchor="middle" fill="#94a3b8" font-size="10" font-weight="bold">STAGE 2</text>
                <text x="50" y="65" text-anchor="middle" fill="white" font-size="12" font-weight="bold">STFT / VAD</text>
                <text x="50" y="80" text-anchor="middle" fill="#3b82f6" font-size="9">microfft (no_std)</text>
            </g>

            <!-- 3. AI Inference (The Brain) -->
            <g transform="translate(430, 130)" class="node-box">
                <rect width="140" height="100" rx="12" fill="#064e3b" stroke="#10b981" stroke-width="2" />
                <text x="70" y="35" text-anchor="middle" fill="#34d399" font-size="10" font-weight="bold">AI INFERENCE TASK</text>
                <text x="70" y="55" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Transformer/Mamba</text>
                <text x="70" y="70" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Tract (INT8 ONNX)</text>
                <rect x="10" y="80" width="120" height="4" rx="2" fill="#022c22" />
                <rect id="ai-progress" x="10" y="80" width="0" height="4" rx="2" fill="#10b981" />
            </g>

            <!-- 4. Wiener Filter (The Filter) -->
            <g transform="translate(430, 370)" class="node-box">
                <rect width="140" height="100" rx="12" fill="#1e293b" stroke="#3b82f6" stroke-width="2" />
                <text x="70" y="45" text-anchor="middle" fill="#94a3b8" font-size="10" font-weight="bold">DSP TASK</text>
                <text x="70" y="65" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Wiener Filter</text>
                <text x="70" y="80" text-anchor="middle" fill="#3b82f6" font-size="9">Neural Guided Gain</text>
            </g>

            <!-- 5. Synthesis -->
            <g transform="translate(730, 370)" class="node-box">
                <rect width="100" height="100" rx="12" fill="#1e293b" stroke="#3b82f6" stroke-width="2" />
                <text x="50" y="45" text-anchor="middle" fill="#94a3b8" font-size="10" font-weight="bold">STAGE 5</text>
                <text x="50" y="65" text-anchor="middle" fill="white" font-size="12" font-weight="bold">ISTFT / OLA</text>
                <text x="50" y="80" text-anchor="middle" fill="#3b82f6" font-size="9">Reconstruction</text>
            </g>

            <!-- 6. Final Result Box -->
            <g transform="translate(850, 150)" class="node-box">
                <rect width="120" height="120" rx="16" fill="#111827" stroke="#f59e0b" stroke-width="3" />
                <text x="60" y="30" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="bold">FINAL OUTPUT</text>
                
                <!-- Audio Status -->
                <g transform="translate(15, 45)">
                    <rect width="90" height="25" rx="4" fill="#1f2937" />
                    <text x="10" y="17" fill="#60a5fa" font-size="9">Audio: CLEAN</text>
                    <path d="M70 17 L75 10 L80 17 L85 10" stroke="#60a5fa" fill="none" />
                </g>

                <!-- String Matrix Status -->
                <g transform="translate(15, 80)">
                    <rect width="90" height="25" rx="4" fill="#1f2937" />
                    <text id="string-matrix-val" x="10" y="17" fill="#fcd34d" font-size="9">Class: Loading...</text>
                </g>
            </g>

            <!-- Floating Data Particles -->
            <circle id="p1" class="data-particle" r="3" />
            <circle id="p2" class="data-particle" r="3" />
            <circle id="p3" class="data-particle" r="3" />

        </svg>
    </main>

    <!-- Console / Info Panel -->
    <footer class="p-4 bg-slate-950 border-t border-slate-800 h-32 flex gap-6 overflow-hidden">
        <div class="flex-1 font-mono text-xs text-slate-500 overflow-y-auto" id="log">
            <div>[INIT] Initializing Q-WiSE Rust Pipeline...</div>
            <div>[HW] Target detected: ESP32-S3 (no_std)</div>
            <div>[ML] Loading Quantized ONNX Model (Tract)...</div>
        </div>
        <div class="w-64 border-l border-slate-800 pl-6 flex flex-col justify-center">
            <div class="text-[10px] text-slate-400 mb-1 uppercase tracking-wider">Energy Monitor</div>
            <div class="flex items-end gap-1">
                <span id="power-val" class="text-2xl font-bold text-emerald-400">32.4</span>
                <span class="text-xs text-slate-500 mb-1">mW</span>
            </div>
            <div class="w-full bg-slate-800 h-1.5 rounded-full mt-2">
                <div id="power-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-500" style="width: 64%"></div>
            </div>
        </div>
    </footer>

    <script>
        const logs = [
            "[AUDIO] I2S Buffer A Filled (Ping)",
            "[DSP] Applying microfft Hann window...",
            "[AI] Tract: Running INT8 Inference...",
            "[AI] Gain map predicted (Length: 128)",
            "[WIENER] Parameterizing filter guidance...",
            "[OUTPUT] Cleared PCM streamed to I2S Out",
            "[META] Matrix updated: Drone Noise detected",
            "[AUDIO] I2S Buffer B Filled (Pong)",
            "[AI] Async task context switch successful",
        ];

        const classifications = ["Clean Speech", "Drone Noise", "Wind", "Smart Warehouse"];
        const logContainer = document.getElementById('log');
        const matrixVal = document.getElementById('string-matrix-val');
        const powerVal = document.getElementById('power-val');
        const powerBar = document.getElementById('power-bar');
        const aiProgress = document.getElementById('ai-progress');

        // Animation Particles
        const particles = [
            { id: 'p1', path: [[150, 300], [230, 300], [380, 300], [380, 180], [430, 180]], duration: 2000 },
            { id: 'p2', path: [[570, 180], [650, 180], [650, 380], [570, 420], [730, 420], [830, 420]], duration: 2500 },
            { id: 'p3', path: [[570, 180], [850, 180]], duration: 1500 }
        ];

        function animateParticle(pObj) {
            const el = document.getElementById(pObj.id);
            let startTime = null;

            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = (timestamp - startTime) / pObj.duration;

                if (progress < 1) {
                    const point = getPointOnPath(pObj.path, progress);
                    el.setAttribute('cx', point.x);
                    el.setAttribute('cy', point.y);
                    el.style.opacity = 1 - progress * 0.5;
                    requestAnimationFrame(step);
                } else {
                    startTime = null;
                    requestAnimationFrame(step);
                }
            }
            requestAnimationFrame(step);
        }

        function getPointOnPath(path, progress) {
            const numSegments = path.length - 1;
            const segmentIdx = Math.min(Math.floor(progress * numSegments), numSegments - 1);
            const segmentProgress = (progress * numSegments) - segmentIdx;
            
            const start = path[segmentIdx];
            const end = path[segmentIdx + 1];
            
            return {
                x: start[0] + (end[0] - start[0]) * segmentProgress,
                y: start[1] + (end[1] - start[1]) * segmentProgress
            };
        }

        // System Simulation Loop
        function simulation() {
            // Update Logs
            const logEntry = document.createElement('div');
            logEntry.textContent = logs[Math.floor(Math.random() * logs.length)];
            logContainer.prepend(logEntry);
            if (logContainer.childNodes.length > 20) logContainer.lastChild.remove();

            // Update String Matrix
            const currentClass = classifications[Math.floor(Math.random() * classifications.length)];
            matrixVal.textContent = `Class: ${currentClass}`;

            // Update Power
            const p = (25 + Math.random() * 15).toFixed(1);
            powerVal.textContent = p;
            powerBar.style.width = `${(p / 50) * 100}%`;
            powerBar.className = p > 45 ? "bg-red-500 h-full rounded-full" : "bg-emerald-500 h-full rounded-full";

            // Update AI Bar
            let aiW = 0;
            const aiInt = setInterval(() => {
                aiW += 10;
                aiProgress.setAttribute('width', aiW + "%");
                if (aiW >= 120) clearInterval(aiInt);
            }, 50);

            setTimeout(simulation, 2000);
        }

        window.onload = () => {
            particles.forEach(animateParticle);
            simulation();
        };
    </script>
</body>
</html>
